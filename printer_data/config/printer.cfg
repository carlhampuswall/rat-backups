#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
#############################################################################################################
[include RatOS.cfg]
#[include custom/OrbiterSensor.cfg]

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: False
variable_preheat_extruder: True
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "front"
variable_start_print_park_z_height: 50
variable_end_print_park_in: "back"
variable_pause_print_park_in: "back"
variable_macro_travel_speed: 400
variable_macro_travel_accel: 8000

# [gcode_macro T0]
# variable_enable_insert_detection: True     # enables the insert detection
# variable_enable_runout_detection: True     # enables the runout detection
# variable_enable_clog_detection: True       # enables the clog detection
# variable_unload_after_runout: True         # unload filament after runout has been detected
# variable_resume_after_insert: True         # resumes the print after inserting new filament

#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: https://www.klipper3d.org/Probe_Calibrate.html#calibrating-probe-z-offset
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
############################################################################################################

[exclude_object]

[printer]
max_accel: 30000
max_velocity: 2000

# OVERRIDE
#############################################################################################################
### FANS
#############################################################################################################
# Part cooling fan
[fan]
# 2-pin fan connected to the toolboard on T0 (toolboard_t0)
pin: toolboard_t0:PA1
tachometer_pin: toolboard_t0:PB8

# Hotend cooling fan
[heater_fan toolhead_cooling_fan]
heater: extruder
# 2-pin fan connected to the toolboard on T0 (toolboard_t0)
pin: toolboard_t0:PA0

[heater_fan voc_fan]
pin: PA0
heater: extruder
heater_temp: 50.0

######
### LEDS
######

[output_pin leds]
pin: PA5



# [filament_switch_sensor toolhead_filament_sensor_t0]
# pause_on_runout: False
# event_delay: 0.1
# # switch_pin: ^!toolboard_t0:PB3
# switch_pin: ^!PE13
# runout_gcode: 
#     _ON_TOOLHEAD_FILAMENT_SENSOR_RUNOUT TOOLHEAD=0
# insert_gcode: 
#     _ON_TOOLHEAD_FILAMENT_SENSOR_INSERT TOOLHEAD=0
# [gcode_button toolhead_filament_sensor_button_t0]
# # pin: ^!toolboard_t0:PB4 
# pin: ^!PE14
# release_gcode:     
#   _ON_FILAMENT_SENSOR_BUTTON_PRESSED TOOLHEAD=0
# press_gcode:


# Controller cooling fan
# No controller fan configured

#---------------------------------------------------- X -----------------------------------------------------
# The A motor in the CoreXY system, located at the rear left of the printer
# Connected to MOTOR 1 on Kraken
#------------------------------------------------------------------------------------------------------------
[tmc5160 stepper_x]
stealthchop_threshold: 0
interpolate: False
run_current: 1.5
#hold_current: 0.5

[stepper_x]
microsteps: 64
full_steps_per_rotation: 200

#---------------------------------------------------- Y -----------------------------------------------------
# The B motor in the CoreXY system, located at the rear right of the printer
# Connected to MOTOR 2 on Kraken
#------------------------------------------------------------------------------------------------------------
[tmc5160 stepper_y]
stealthchop_threshold: 0
interpolate: False
run_current: 1.5
#hold_current: 0.5

[stepper_y]
microsteps: 64
full_steps_per_rotation: 200





#---------------------------------------------------- X -----------------------------------------------------
# The A motor in the CoreXY system, located at the rear left of the printer
# Connected to MOTOR 1 on Kraken
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: !x_dir_pin                 # Add ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40              # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: 0
position_max: 300
position_endstop: 0

#---------------------------------------------------- Y -----------------------------------------------------
# The B motor in the CoreXY system, located at the rear right of the printer
# Connected to MOTOR 2 on Kraken
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: !y_dir_pin                 # Add ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40              # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 50
position_min: -15
position_max: 280
position_endstop: 280
endstop_pin: PC15

#---------------------------------------------------- Z -----------------------------------------------------
# The left Z motor for the kinematic bed
# Connected to MOTOR 6 on Kraken
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: z0_dir_pin               # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 4               # 4 for TR8*4 lead screws
homing_speed: 10
position_min: -5
position_max: 300

#---------------------------------------------------- Z1 ----------------------------------------------------
# The rear Z motor for the kinematic bed
# Connected to MOTOR 7 on Kraken
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: z1_dir_pin               # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 4               # 4 for TR8*4 lead screws

#---------------------------------------------------- Z2 ----------------------------------------------------
# The right Z motor for the kinematic bed
# Connected to MOTOR 8 on Kraken
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: z2_dir_pin               # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 4               # 4 for TR8*4 lead screws

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for pushing filament through the toolhead
# Connected to EBB42 v1.2
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: toolboard_t0:e_dir_pin   # Remove ! in front of pin name to reverse the direction of extruder
rotation_distance: 4.63            # Orbiter 2 default
#pressure_advance: 0.05            # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
#control: pid
#pid_kp: 28.413
#pid_ki: 1.334
#pid_kd: 151.300
min_temp: 5
max_temp: 350

nozzle_diameter: 0.4

#sensor_type: MAX31865
#sensor_pin: toolboard_t0:PA4
#spi_bus: spi1
#rtd_nominal_r: 1000
#rtd_reference_r: 4300
#rtd_num_of_wires: 2

sensor_type: PT1000
sensor_pin: toolboard_t0:PA3
pullup_resistor: 2200

[heater_bed]
#control: pid
#pid_Kp: 22.2
#pid_Ki: 1.08
#pid_Kd: 114
heater_pin: PF7

# Probe configuration
[probe]
#z_offset: 0.0 # Will be commented out after a successful PROBE_CALIBRATE and SAVE_CONFIG
pin: ^toolboard_t0:probe_pin# For NPN NC probes such as the Super Pinda / Vinda / SupCR / Decoprobe probes.
#pin: ^!toolboard_t0:probe_pin # NPN NO (refer to the specs of your probe)
#pin: toolboard_t0:probe_pin # PNP NO (refer to the specs of your probe)
#pin: !toolboard_t0:probe_pin # PNP NC (refer to the specs of your probe)

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 56.814
#*# pid_ki = 1.795
#*# pid_kd = 449.543
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 24.848
#*# pid_ki = 2.045
#*# pid_kd = 75.476
#*#
#*# [bed_mesh ratos]
#*# version = 1
#*# points =
#*# 	  -0.018750, -0.015000, 0.003125
#*# 	  0.006562, 0.006562, 0.026562
#*# 	  0.011250, 0.019687, 0.035000
#*# x_count = 3
#*# y_count = 3
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = lagrange
#*# tension = 0.2
#*# min_x = 108.35000000000001
#*# max_x = 191.64999999999998
#*# min_y = 103.35
#*# max_y = 186.65
#*#
#*# [probe]
#*# z_offset = 2.143
#*#
#*# [input_shaper]
#*# shaper_type_x = zv
#*# shaper_freq_x = 81.6
#*# shaper_type_y = mzv
#*# shaper_freq_y = 52.0
